# lcygzfront 生产环境部署指南（Ubuntu 24.04 LTS）

本文档说明如何在 **Ubuntu 24.04 LTS** 上部署本前端项目，并通过 **Nginx + HTTPS** 对外提供服务，域名为：

- `https://www.guzhenscjy.cn`

后端（NestJS，项目 `lcygzback`）已在同一台服务器上部署，并通过 **PM2** 管理，具体请参考《lcygzback 生产环境部署指南（Ubuntu 24.04 LTS）》。

## 1. 部署架构概览

- 前端：React + Vite SPA
  - 使用 `pnpm build` 构建，生成纯静态资源 `dist/`
  - 由 Nginx 直接提供静态文件
- 后端：NestJS（lcygzback）
  - 监听 `http://127.0.0.1:3000`
  - 使用 PM2 管理进程（`pm2 start dist/src/main.js --name lcygzback`）
- 网关：Nginx
  - `https://www.guzhenscjy.cn` → 前端静态页面
  - `https://www.guzhenscjy.cn/api/**` → 反向代理到 `http://127.0.0.1:3000/**`（后端 API）
  - `https://www.guzhenscjy.cn/uploads/**` → 反向代理到 `http://127.0.0.1:3000/uploads/**`（作品文件）
- 进程管理：
  - 前端为静态资源，不需要 PM2
  - 后端继续由 PM2 管理（见后端部署文档）

> 推荐做法：**所有浏览器访问都走 `https://www.guzhenscjy.cn`，由 Nginx 统一转发到后端**，这样前端配置 `VITE_API_BASE_URL=https://www.guzhenscjy.cn/api` 即可，无需额外 CORS 配置。

---

## 2. 前置条件

### 2.1 服务器与账号

- 一台运行 **Ubuntu 24.04 LTS** 的服务器
- 已有一个具有 `sudo` 权限的部署用户（例如在后端部署中已经创建）

### 2.2 基础软件

如果你已经按照后端部署文档安装过 Node.js、pnpm，可以跳过本小节。

```bash
# 更新系统
sudo apt update
sudo apt install -y curl git build-essential nginx

# （可选）使用 nvm 安装 Node.js LTS
curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
source ~/.bashrc
nvm install --lts
nvm use --lts

# 安装 pnpm
npm install -g pnpm
```

### 2.3 域名解析

在域名服务商后台，将：

- `www.guzhenscjy.cn` 的 A 记录指向你的服务器公网 IP。

---

## 3. 获取前端代码

假设前端部署路径为 `/opt/lcygzfront`，并且你已经将本仓库推送到自己的 Git 仓库（下面用占位符 `<your-frontend-repo-url>` 表示）：

```bash
sudo mkdir -p /opt/lcygzfront
sudo chown -R $USER:$USER /opt/lcygzfront

cd /opt/lcygzfront
git clone <your-frontend-repo-url> .
```

后续更新上线只需：

```bash
cd /opt/lcygzfront
git pull
```

---

## 4. 配置前端环境变量

项目使用 Vite 的构建时环境变量，所有变量需以 `VITE_` 开头。对应映射见 `src/constants.ts`：

- `VITE_API_BASE_URL` → 后端 API 基础地址
- `VITE_CONTEST_NAME` → 比赛名称
- `VITE_SCHOOL_NAME` → 学校名称
- `VITE_CONTEST_DEADLINE` → 截止时间（ISO 字符串）

### 4.1 创建 `.env.production`

在前端项目根目录创建生产环境配置文件：

```bash
cd /opt/lcygzfront
nano .env.production
```

示例内容（请根据实际情况调整）：

```env
# 后端 API 地址：通过 Nginx 暴露为 /api
VITE_API_BASE_URL="https://www.guzhenscjy.cn/api"

# 比赛显示名称
VITE_CONTEST_NAME="2025图形化编程创意赛"

# 学校显示名称
VITE_SCHOOL_NAME="中山市光正实验学校"

# 报名截止时间（示例，按实际时间填写）
VITE_CONTEST_DEADLINE="2025-06-30T23:59:59.000Z"
```

> 注意：`.env.production` 在 **构建阶段** 生效，如果修改了该文件，需要重新执行 `pnpm build`。

---

## 5. 构建前端（生成 dist）

在服务器上构建前端：

```bash
cd /opt/lcygzfront

# 安装依赖（只在首次或依赖变更时需要）
pnpm install

# 使用生产配置构建
pnpm build
```

执行成功后，会在 `dist/` 目录生成静态文件：

- `index.html`
- `assets/**` 等

---

## 6. 配置 Nginx

### 6.1 安装与基础配置

如果尚未安装 Nginx：

```bash
sudo apt install -y nginx

# 防火墙开放 HTTP/HTTPS（如使用 ufw）
sudo ufw allow 'Nginx Full'
```

### 6.2 创建站点配置

创建 Nginx 配置文件，例如 `/etc/nginx/sites-available/guzhenscjy.conf`：

```bash
sudo nano /etc/nginx/sites-available/guzhenscjy.conf
```

示例配置：

```nginx
server {
    listen 80;
    server_name www.guzhenscjy.cn;

    # 前端构建输出目录
    root /opt/lcygzfront/dist;
    index index.html;

    # 前端 SPA：所有未知路径回退到 index.html
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API 反向代理到后端 NestJS（lcygzback）
    location /api/ {
        # /api/submissions -> http://127.0.0.1:3000/submissions
        proxy_pass http://127.0.0.1:3000/;

        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 上传文件访问：转发到后端的 /uploads/**
    location /uploads/ {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 可选：增加一些基础安全 / 缓存头（按需调整）
}
```

启用该站点并重载 Nginx：

```bash
sudo ln -s /etc/nginx/sites-available/guzhenscjy.conf /etc/nginx/sites-enabled/guzhenscjy.conf

# 检查配置是否正确
sudo nginx -t

# 重载配置
sudo systemctl reload nginx
```

此时，访问 `http://www.guzhenscjy.cn` 应该可以看到前端页面（尚未开启 HTTPS）。

---

## 7. 配置 HTTPS（Let's Encrypt）

使用 Certbot 为 Nginx 自动签发并配置证书：

```bash
# 安装 certbot（使用 snap 方式）
sudo snap install core
sudo snap refresh core
sudo snap install --classic certbot
sudo ln -s /snap/bin/certbot /usr/bin/certbot

# 为 www.guzhenscjy.cn 签发证书并自动配置 Nginx
sudo certbot --nginx -d www.guzhenscjy.cn
```

按提示完成邮箱与协议确认，选择自动重定向 HTTP → HTTPS。

证书自动续期：

```bash
sudo systemctl status snap.certbot.renew.service
# 或手动测试续期流程
sudo certbot renew --dry-run
```

---

## 8. 前后端协同与 PM2

### 8.1 后端（lcygzback）

后端已经按照《lcygzback 生产环境部署指南》部署，关键点如下（简要回顾）：

- 项目路径：`/opt/lcygzback`
- 使用 PM2 启动：

  ```bash
  cd /opt/lcygzback
  NODE_ENV=production pm2 start dist/src/main.js --name lcygzback
  ```

- 确保后端监听 `0.0.0.0:3000` 或 `127.0.0.1:3000`，与 Nginx 配置一致。

### 8.2 前端（lcygzfront）

前端是纯静态资源，由 Nginx 直接读取 `dist/`，不需要使用 PM2 管理进程。

更新前端代码时的流程建议：

```bash
cd /opt/lcygzfront

# 拉取最新代码
git pull

# 如有依赖更新
pnpm install

# 更新 .env.production（如有变更）

# 重新构建
pnpm build

# 检查 Nginx 正常
sudo nginx -t && sudo systemctl reload nginx
```

更新完成后，浏览器访问 `https://www.guzhenscjy.cn` 即可看到最新版本。

---

## 9. 常见排查点

- 打开页面白屏或 404：
  - 检查 Nginx 的 `root` 路径是否指向 `/opt/lcygzfront/dist`
  - 确认 `pnpm build` 成功且 `dist/` 不为空
  - 确认 `location / { try_files ... }` 正确写为 `try_files $uri $uri/ /index.html;`
- 提交作品时报网络错误：
  - 确认后端 PM2 进程 `lcygzback` 正常运行：`pm2 status`
  - 确认 Nginx `/api/` 反向代理配置，访问 `https://www.guzhenscjy.cn/api/` 是否能返回后端根路径（如 "Hello World!"）
  - 确认 `.env.production` 中 `VITE_API_BASE_URL` 与 Nginx 反代路径一致（推荐为 `https://www.guzhenscjy.cn/api`）
- 成功提交但无法打开作品文件：
  - 访问一个具体的上传 URL（如 `https://www.guzhenscjy.cn/uploads/...`），检查是否能被 Nginx 转发到后端
  - 确认后端的 `uploads/` 目录路径与 Nginx 代理一致（默认 `/uploads/**`）

---

## 10. 后续优化建议

- 将前端、后端部署步骤整理为脚本或 Ansible Playbook，减少手动操作。
- 配合 Git 标签或 CI/CD，将 `git pull + pnpm build + nginx reload` 自动化。
- （可选）为后端开启访问日志轮转与监控（如使用 pm2 monit / pm2-logrotate）。

